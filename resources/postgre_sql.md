# PostgreSQL

## Почему PostgreSQL?

1. Это правильный вопрос, особенно если вы уже знакомы с другими базами данных, такими как SQLite, которые проще настроить, запускать локально и не следовать модели клиент-сервер.
2. Ответ заключается в том, что модель клиент-сервер, которой следует PostgreSQL, обеспечивает надежность, масштабируемость и эффективность при обработке больших объемов данных.
3. Кроме того, он обеспечивает расширенный параллелизм с помощью таких функций, как многострочные транзакции. Вышеупомянутое необходимо для современных, сложных, реальных приложений, и неклиент-серверные базы данных, такие как SQLite, не могут этого гарантировать.

## Клиент серверная модель

1. Локальная (не клиент-серверная) база данных предназначена для работы на одном компьютере или устройстве, хранит данные локально и доступна приложениям на том же компьютере.
2. Эта настройка идеальна для автономных приложений, где простота и легкость развертывания являются приоритетами.
3. С другой стороны, база данных клиент-сервер работает в сетевой среде, где сервер базы данных работает независимо от клиентских приложений.
4. Клиенты подключаются к серверу по сети для запроса, обновления и управления данными.
   - Конечно, сервер и клиент могут находиться на одной машине.
   - В основном сделано в образовательных целях (как этот урок).

### Настройка в MacOS: Прямая установка

1. Загрузите последнюю версию [PostgreSQL](https://www.enterprisedb.com/downloads/postgres-postgresql-downloads) для macOS.
2. Дважды щелкните загруженный файл, чтобы запустить установщик.
   1. Нажмите «Далее». Вы можете увидеть предупреждающее сообщение, поскольку оно было загружено из Интернета. Если да, нажмите «Открыть», чтобы продолжить.
   2. Оставьте папку установки по умолчанию и нажмите «Далее».
   3. Оставьте компоненты по умолчанию и нажмите «Далее».
   4. Оставьте местоположение по умолчанию (там будут храниться файлы базы данных).
   5. Вам будет предложено создать пароль; обязательно запомните это. Нажмите «Далее».
   6. Оставьте параметры по умолчанию (порт и локаль) и нажмите «Далее».
   7. Нажмите «Далее»; при необходимости укажите пароль Mac OS (тот, который вы используете для разблокировки ноутбука).
   8. Нажмите «Готово».
3. Откройте PgAdmin из папки «Приложения».
4. В верхнем левом углу PgAdmin разверните параметр «Серверы», щелкнув по нему.
5. Нажмите «PostgreSQL»; при появлении запроса используйте пароль, созданный на шаге 2.4.
6. Теперь вы подключены к PostgreSQL.

### Настройка на MacOS: с опциями

1. Загрузите последнюю версию [Postgress.app](https://postgresapp.com/downloads.html).
2. Откройте загруженный файл .dmg.
3. Перетащите Postgres в папку «Приложения».
4. Откройте папку «Приложения», затем откройте Postgres. При первом открытии приложения вы можете увидеть предупреждающее сообщение, поскольку оно было загружено из Интернета. Если да, нажмите «Открыть», чтобы продолжить.
5. Когда приложение откроется, нажмите «Инициализировать», чтобы начать сеанс PostgreSQL.
6. Вы можете увидеть существующие базы данных (они созданы по умолчанию). Дважды щелкните один, и откроется терминал для выполнения запросов к этой базе данных.
7. Теперь вы подключены к PostgreSQL.

### Настройка в MacOS: инструменты командной строки (Setup on MacOS: Command-Line Tools)

1. Откройте окно терминала.
2. Запустите файл `~/.zshrc` (или `~/.bashrc` в зависимости от вашей оболочки).
3. Добавьте следующую строку в конец файла: `Export PATH=$PATH:/Applications/Postgres.app/Contents/Versions/latest/bin`.
4. Обновите шелл в терминале `~/.zshrc`.
5. Проверьте установку, запустив `psql`.

## Установка и настройка PostgreSQL (Windows)

 - Детальный процесс установки на Windows можно посмотреть на [сайте](https://postgrespro.ru/windows) PostgresPro


## Установка PgAdmin

- Перейдите на [сайт PgAdmin](https://www.pgadmin.org/download/)
- Скачайте дистрибутив для вашей системы
- Выполните установку


## Запуск запросов с помощью PgAdmin

1. Откройте PgAdmin.
2. Щелкните правой кнопкой мыши «Базы данных» -> «Создать» -> «База данных». В поле «База данных» напишите «пингвины» и нажмите «Сохранить».
3. Щелкните правой кнопкой мыши базу данных «пингвинов» в меню слева: a. Нажмите «Инструмент запросов». б. Нажмите «Открыть файл» в левом верхнем углу инструмента запросов. в. Выберите файл `db/penguins.sql`. д. Нажмите «Выполнить».
4. Разверните «пингвины» -> «Схемы» -> «Таблицы». Вы должны увидеть две таблицы: `Little_penguins` и `Penguins`.
5. Щелкните правой кнопкой мыши по `penguins` -> «Инструмент запросов» (Query tool).
6. Запустите запрос, чтобы увидеть первые записи таблицы пингвинов.

```sql
select * from penguins limit 10;
```

- Посчитайте пингвинов:

```sql
select count(*) from penguins;
```

## Запуск запросов в терминале

- Запустите клиент PostgreSQL из командной строки и укажите ему, какую базу данных использовать:

```
psql -d penguins 
```

- Запустите запросы из предыдущего раздела.

## Привилегии и роли

- PostgreSQL обычно используется для приложений с большой базой пользователей.
- По этой причине в нем имеется система управления привилегиями, позволяющая контролировать, кто имеет какой доступ к каким данным.
  - Возможно, вы захотите, чтобы пользователи вашего приложения могли читать записи SQL, но не обновляли и не удаляли их.
  - Или в организации, где много разработчиков работают с одной и той же базой данных, может быть желательно, чтобы некоторые команды разработчиков могли только читать существующие или записывать новые записи, но не изменять или удалять существующие записи.

## Создание роли и предоставление привилегий

- Роль базы данных аналогична учетной записи пользователя.
  - Может владеть объектами базы данных
  - Могут быть предоставлены разрешения на доступ к данным и манипулирование ими.
- Роли могут представлять отдельных пользователей, группы пользователей или и то, и другое.
- Могут быть назначены различные привилегии и права доступа в базе данных.

- Создайте роль в PgAdmin:
  1. На панели обозревателя объектов разверните Серверы -> PostgreSQL -> щелкните правой кнопкой мыши Роли входа/группы -> Создать -> Роль входа/группы.
  2. Введите «penguin_reader_writer» в поле «имя».
  3. Перейдите на вкладку «Привилегии»(Privileges) и включите параметр «Можно войти?». вариант.
  4. Нажмите «Сохранить».

- Предоставьте разрешения в PgAdmin:
  1. Щелкните правой кнопкой мыши таблицу `penguins` в обозревателе объектов.
  2. Перейдите в «Свойства» -> «Безопасность» -> нажмите кнопку «+» в правом верхнем углу.
  3. Выберите «penguin_reader_writer» из раскрывающегося списка.
  4. В столбце «Привилегии» отметьте опции «ВЫБРАТЬ» и «ОБНОВИТЬ».
  5. Нажмите «Сохранить».

- Создайте роль в терминале:

```shell
create role penguin_reader_writer
with login password 'reader_writer';
```

- Предоставьте разрешения в терминале:

```shell
grant select, update on penguins
to penguin_reader_writer;
```

## Проверка привилегий в PgAdmin

- Подключитесь как penguin_reader_writer, чтобы убедиться, что эта роль может только выбирать или обновлять записи:
  1. Щелкните правой кнопкой мыши «Серверы» -> «Регистрация» -> «Сервер» на левой панели.
  2. В поле «имя» введите «Penguin Reader Writer».
  3. Перейдите на вкладку «Подключение»: а. В поле «Имя/адрес хоста» введите «localhost». б. В поле «База данных обслуживания» введите «пингвины». в. В поле «Имя пользователя» введите «penguin_reader_writer». д. В поле «Пароль» введите «reader_writer».
  4. Нажмите «Сохранить».

- Закройте и снова откройте PgAdmin, но вместо «PostgreSQL» выберите в качестве идентификатора пользователя «Penguin Reader Writer».

- Запустите простой запрос, который считывает данные:

```sql
select * from penguins limit 10;
```

- Он успешно возвращает 10 записей из таблицы.
- Теперь попробуйте изменить данные:

```sql
update penguins
set island = 'Antarctica'
where sex = 'MALE' and island = 'Torgersen';
```

- Это тоже работает (обновляет 23 записи).
- Но теперь попробуйте удалить данные:

```sql
delete from penguins
where island='Antarctica' and sex='MALE';
```
```
psql:delete_penguins.sql:2: ERROR:  permission denied for table penguins
```

- Поскольку роль penguin_reader_writer не имеет привилегий DELETE.

## Отзыв привилегий

- Ужесточить доступ, чтобы у penguin_reader_writer не было прав UPDATE (только SELECT)
- В PgAdmin:
  1. Щелкните правой кнопкой мыши таблицу `penguins` на панели обозревателя объектов.
  2. Перейдите в «Свойства» -> «Безопасность» -> Щелкните столбец «Привилегии» строки penguin_reader_writer.
  3. Снимите флажок «Обновить».
  4. Нажмите «Сохранить».

- В терминале:

```shell
revoke update on penguins
from penguin_reader_writer;
```

- Чтобы проверить (Вы должны находиться в `psql`):

```shell
update penguins
set island = 'Atlantis'
where sex = 'MALE' and island = 'Antarctica';
```
```
psql:update_penguins_again.sql:3: ERROR:  permission denied for table penguins
```




